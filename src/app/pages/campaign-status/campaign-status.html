<div class="campaign-status-page">
  <app-burger-menu></app-burger-menu>

  <div class="campaigns-container">
    <div class="header">
      <h2>Campaigns</h2>
    </div>

    <div class="dashboard-controls">
      <app-button shape="circular" appearance="outline" (click)="toggleView()">
        {{ viewMode() }}
        View
      </app-button>

      <app-button shape="circular" appearance="outline" (click)="exportCSV()">
        Export CSV
      </app-button>

      <input
        type="text"
        class="search-input"
        placeholder="Search campaigns..."
        [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event)"
      />

      <button class="change-view-btn">
        @if(viewMode() === 'Cards') {
        <span class="material-symbols-outlined">cards</span><span>Card</span>
        }
      </button>
    </div>

    <div class="dashboard-content">
      @if (viewMode() === 'Cards') {
      <div class="campaign-cards">
        @for (campaign of pagedCampaigns(); track trackByCampaignId($index,
        campaign)) {
        <div class="campaign-wrapper">
          <app-campaign-card
            [title]="campaign.title"
            [description]="'Votes: ' + getTotalVotes(campaign)"
            [image]="getImage(campaign)"
            size="medium"
            [showKebabMenu]="true"
            [showEditOption]="true"
            [showDeleteOption]="true"
            (cardClick)="openCampaignDetails(campaign)"
            (edit)="editCampaign(campaign.id)"
            (delete)="deleteCampaign(campaign.id)"
          >
            <div class="card-meta">
              <div class="meta-row">
                <div class="meta-item">
                  <div class="meta-value">{{ getTotalVotes(campaign) }}</div>
                  <div class="meta-label">Total votes</div>
                </div>
                <div class="meta-item">
                  <div class="meta-value">{{ getTopCandidate(campaign) }}</div>
                  <div class="meta-label">Top candidate</div>
                </div>
                <div class="meta-item">
                  <div class="meta-value">{{ candidateCount(campaign) }}</div>
                  <div class="meta-label">Candidates</div>
                </div>
              </div>
            </div>
          </app-campaign-card>
        </div>
        }
      </div>

      <mat-paginator
        [length]="filteredCampaigns().length"
        [pageSize]="pageSize"
        [pageSizeOptions]="[4, 8, 12]"
        (page)="onPageChange($event)"
        aria-label="Select page"
        class="campaign-paginator"
      >
      </mat-paginator>
      }

      <div
        class="drawer-backdrop"
        [class.visible]="!!selectedCampaign()"
        (click)="closeCampaignDetails()"
      ></div>

      <div class="side-drawer" [class.open]="!!selectedCampaign()">
        @if (selectedCampaign(); as sc) {
        <div class="drawer-inner">
          <div class="drawer-header">
            <h3>{{ sc.title }}</h3>
            <app-button appearance="secondary" (click)="closeCampaignDetails()">
              Close
            </app-button>
          </div>

          <div class="winner">
            <div class="winner-label"><h2>Top Candidate</h2></div>
            <div class="winner-value">{{ getTopCandidate(sc) }}</div>
          </div>

          <div class="drawer-stats">
            <div class="stat">
              <div class="stat-label">Total Votes</div>
              <div class="stat-value">{{ getTotalVotes(sc) }}</div>
            </div>

            <div class="stat">
              <div class="stat-label">Candidates</div>
              <div class="stat-value">{{ candidateCount(sc) }}</div>
            </div>
          </div>

          @if (candidateCount(sc) > 0) {
          <div class="ranks-and-chart">
            <!--<div class="ranks">
              <div class="ranks-title">Ranks</div>
              @for (rc of getRankedCandidates(sc); track $index) {
              <div class="rank-item">
                {{ getOrdinal($index + 1) }} â€” {{ rc.name }} ({{
                  getCandidateVotes(sc.id, rc.name)
                }}
                votes)
              </div>
              }
            </div> -->

            <div class="drawer-chart">
              <div
                echarts
                [options]="getChartOptions(sc, 'pie')"
                class="echart"
              ></div>
            </div>
          </div>
          }

          <div class="candidate-grid">
            @for (candidate of sc.candidates; track trackByCandidateName($index,
            candidate)) {
            <div class="candidate-item">
              <div class="candidate-votes-text">
                <span class="material-symbols-outlined">arrow_circle_up</span>
                {{ getCandidateVotes(sc.id, candidate.name) }}
              </div>
              <app-campaign-card
                [title]="candidate.name"
                [description]="candidate.bio"
                [image]="getImage(candidate)"
                size="small"
              >
              </app-campaign-card>
            </div>
            }
          </div>
        </div>
        }
      </div>

      @if (viewMode() === 'Charts') {
      <div class="chart-view">
        @for (campaign of filteredCampaigns(); track trackByCampaignId($index,
        campaign)) {
        <div class="campaign-charts-container">
          <h3 class="campaign-title">{{ campaign.title }}</h3>
          <div class="charts-grid">
            <div class="chart-item">
              <h4 class="chart-label">Pie Chart</h4>
              <div
                echarts
                [options]="getChartOptions(campaign, 'pie')"
                class="echart"
              ></div>
            </div>
            <div class="chart-item">
              <h4 class="chart-label">Bar Chart</h4>
              <div
                echarts
                [options]="getChartOptions(campaign, 'bar')"
                class="echart"
              ></div>
            </div>
            <div class="chart-item">
              <h4 class="chart-label">Line Chart</h4>
              <div
                echarts
                [options]="getChartOptions(campaign, 'line')"
                class="echart"
              ></div>
            </div>
          </div>
        </div>
        }
      </div>
      } @if(viewMode() === 'List') {

      <cdk-table class="list-view" [dataSource]="pagedCampaigns()">
        <ng-container cdkColumnDef="title">
          <cdk-header-cell *cdkHeaderCellDef>Title</cdk-header-cell>
          <cdk-cell *cdkCellDef="let campaign">{{ campaign.title }}</cdk-cell>
        </ng-container>
        <!-- Votes Column -->
        <ng-container cdkColumnDef="votes">
          <cdk-header-cell *cdkHeaderCellDef> Total Votes </cdk-header-cell>
          <cdk-cell *cdkCellDef="let campaign">
            {{ getTotalVotes(campaign) }}
          </cdk-cell>
        </ng-container>

        <ng-container cdkColumnDef="start_date_column">
          <cdk-header-cell *cdkHeaderCellDef>Start Date</cdk-header-cell>
          <cdk-cell *cdkCellDef="let campaign">
            {{ campaign.start_date | date }}
          </cdk-cell>
        </ng-container>

        <ng-container cdkColumnDef="end_date_column">
          <cdk-header-cell *cdkHeaderCellDef>End Date</cdk-header-cell>
          <cdk-cell *cdkCellDef="let campaign">
            {{ campaign.end_date | date }}
          </cdk-cell>
        </ng-container>

        <ng-container cdkColumnDef="actions">
          <cdk-header-cell *cdkHeaderCellDef> Actions </cdk-header-cell>
          <cdk-cell *cdkCellDef="let campaign">
            <div class="action-buttons">
              <app-button
                size="small"
                appearance="outline"
                shape="circular"
                (click)="editCampaign(campaign.id)"
              >
                <span class="material-symbols-outlined">edit</span>
              </app-button>
              <app-button
                size="small"
                appearance="primary"
                shape="circular"
                (click)="deleteCampaign(campaign.id)"
              >
                <span class="material-symbols-outlined">delete</span>
              </app-button>
            </div>
          </cdk-cell>
        </ng-container>

        <cdk-header-row *cdkHeaderRowDef="displayedColumns"></cdk-header-row>
        <cdk-row
          *cdkRowDef="let row; columns: displayedColumns"
          (click)="openCampaignDetails(row)"
        ></cdk-row>
      </cdk-table>

      }
    </div>
  </div>
</div>
